<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Scrollable Blue & White Matrix Weather Widget</title>
  <style>
    html, body {
      margin: 0; padding: 0; height: 200vh; /* enable scroll */
      background: #001F4D;
      font-family: 'Courier New', monospace;
      color: #00BFFF;
      overflow-y: auto;
    }
    canvas#matrix {
      position: fixed;
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
      z-index: 0;
      display: block;
    }
    #weather-widget {
      position: relative;
      z-index: 1;
      max-width: 350px;
      margin: 50px auto;
      background: rgba(0, 32, 80, 0.85);
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 0 20px #009FFFAA;
      color: #BDEFFF;
    }
    h3 {
      margin-top: 0;
      font-weight: 700;
      font-size: 1.5rem;
      text-align: center;
      text-shadow: 0 0 15px #00BFFF;
      user-select: none;
    }
    .input-group {
      display: flex;
      gap: 10px;
      margin-bottom: 16px;
    }
    input[type="text"] {
      flex-grow: 1;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #00BFFF;
      background: #0E1E3F;
      color: #BDEFFF;
      font-weight: 700;
      outline-offset: 2px;
    }
    input::placeholder {
      color: #336B99;
    }
    input:focus {
      box-shadow: 0 0 8px #00BFFF;
    }
    button {
      background: #00BFFF;
      color: black;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      padding: 10px 14px;
      font-weight: 700;
      transition: background 0.3s ease;
    }
    button:hover {
      background: #0099DD;
    }
    #resultWidget {
      font-size: 0.9rem;
      margin-bottom: 16px;
      text-shadow: 0 0 6px #BDEFFF;
    }
    .current-weather {
      background: rgba(0, 191, 255, 0.3);
      border-radius: 15px;
      padding: 18px;
      display: flex;
      gap: 15px;
      align-items: center;
    }
    .current-weather img {
      width: 60px;
      height: 60px;
    }
    .weather-info .city {
      font-size: 1.3rem;
      font-weight: 700;
    }
    .weather-info .desc {
      font-size: 1.1rem;
      text-transform: capitalize;
      margin-bottom: 8px;
    }
    #forecastWidget > div {
      background: rgba(0, 143, 255, 0.4);
      border-radius: 12px;
      margin-bottom: 10px;
      padding: 10px 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 700;
      font-size: 0.9rem;
    }
    #forecastWidget img {
      width: 40px;
      height: 40px;
    }
    #forecastChartWidget {
      margin-top: 20px;
      border-radius: 12px;
      background: rgba(0, 80, 160, 0.7);
      box-shadow: 0 0 15px #00BFFFAA;
      width: 100% !important;
      height: 200px !important;
    }
    .error {
      color: #FF7777;
      font-weight: 700;
      text-align: center;
      margin: 20px 0;
    }
  </style>
</head>
<body>
  <canvas id="matrix"></canvas>

  <div id="weather-widget" role="region" aria-label="Live weather widget">
    <h3>Matrix Weather</h3>
    <div class="input-group">
      <input type="text" id="cityInputWidget" placeholder="Enter city (e.g. New York)" aria-label="City name" />
      <button id="getWeatherBtn" aria-label="Get weather">Get</button>
    </div>
    <div id="resultWidget" aria-live="polite"></div>
    <div id="forecastWidget"></div>
    <canvas id="forecastChartWidget" aria-hidden="true"></canvas>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const canvas = document.getElementById('matrix');
    const ctx = canvas.getContext('2d');

    function resize() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    resize();
    window.addEventListener('resize', resize);

    const letters = 'abcdefghijklmnopqrstuvwxyz0123456789@#$%^&*';
    const fontSize = 18;
    const columns = Math.floor(canvas.width / fontSize);
    const drops = Array(columns).fill(1);

    function draw() {
      ctx.fillStyle = 'rgba(0, 0, 0, 0.15)';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      ctx.fillStyle = '#FFFFFF'; // white text
      ctx.font = fontSize + 'px monospace';

      for (let i = 0; i < drops.length; i++) {
        const text = letters.charAt(Math.floor(Math.random() * letters.length));
        ctx.fillText(text, i * fontSize, drops[i] * fontSize);

        if (drops[i] * fontSize > canvas.height && Math.random() > 0.975) {
          drops[i] = 0;
        }
        drops[i]++;
      }
    }
    setInterval(draw, 50);

    (function () {
      const apiKey = '733ec5a871dceb31719ab4f3bebf65de'; // Your OpenWeatherMap API key here
      let chartInstance = null;

      function clearChart() {
        if (chartInstance) {
          chartInstance.destroy();
          chartInstance = null;
        }
      }

      function showError(message) {
        document.getElementById('resultWidget').innerHTML = '<div class="error">' + message + '</div>';
        document.getElementById('forecastWidget').innerHTML = '';
        clearChart();
      }

      function clearError() {
        document.getElementById('resultWidget').innerHTML = '';
      }

      function renderChart(labels, maxTemps, minTemps) {
        clearChart();
        const ctx = document.getElementById('forecastChartWidget').getContext('2d');
        chartInstance = new Chart(ctx, {
          type: 'line',
          data: {
            labels,
            datasets: [
              {
                label: 'Max Temp (°C)',
                data: maxTemps,
                borderColor: '#00BFFF',
                backgroundColor: 'rgba(0,191,255,0.3)',
                fill: true,
                tension: 0.3,
              },
              {
                label: 'Min Temp (°C)',
                data: minTemps,
                borderColor: '#0088CC',
                backgroundColor: 'rgba(0,136,204,0.3)',
                fill: true,
                tension: 0.3,
              },
            ],
          },
          options: {
            responsive: true,
            interaction: { mode: 'index', intersect: false },
            stacked: false,
            plugins: { legend: { labels: { color: '#BDEFFF' }, position: 'top' } },
            scales: {
              y: { beginAtZero: false, ticks: { color: '#BDEFFF' } },
              x: { ticks: { color: '#BDEFFF' } },
            },
          },
        });
      }

      function displayCurrentWeather(data) {
        const sunrise = new Date(data.sys.sunrise * 1000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const sunset = new Date(data.sys.sunset * 1000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const iconCode = data.weather[0].icon;
        const iconUrl = `https://openweathermap.org/img/wn/${iconCode}@2x.png`;
        const desc = data.weather[0].description;
        const resultDiv = document.getElementById('resultWidget');
        resultDiv.innerHTML = `
          <div class="current-weather" style="color:#BDEFFF; display:flex; align-items:center; gap:15px; background: rgba(0, 191, 255, 0.3); padding: 18px; border-radius: 15px;">
            <img src="${iconUrl}" alt="${desc}" style="width:60px;height:60px;">
            <div>
              <div style="font-size:1.3rem; font-weight:700;">${data.name}</div>
              <div style="font-size:1.1rem; text-transform: capitalize;">${desc}</div>
              <div>Temp: ${data.main.temp} °C (Feels like ${data.main.feels_like} °C)</div>
              <div>Humidity: ${data.main.humidity} %</div>
              <div>Wind: ${data.wind.speed} m/s</div>
              <div>Sunrise: ${sunrise} | Sunset: ${sunset}</div>
            </div>
          </div>
        `;
      }

      function getForecast(lat, lon) {
        fetch(`https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&units=metric&appid=${apiKey}`)
          .then(res => {
            if (!res.ok) throw new Error('Failed to fetch forecast');
            return res.json();
          })
          .then(data => {
            const days = {};
            data.list.forEach(item => {
              const date = item.dt_txt.split(' ')[0];
              if (!days[date]) days[date] = [];
              days[date].push(item);
            });
            const dailySummaries = Object.keys(days).map(date => {
              const temps = days[date].map(x => x.main.temp);
              const minTemp = Math.min(...temps);
              const maxTemp = Math.max(...temps);
              const weather = days[date][0].weather[0];
              return { date, minTemp, maxTemp, weather };
            });
            const forecastDiv = document.getElementById('forecastWidget');
            forecastDiv.innerHTML = dailySummaries
              .map(day => {
                const iconUrl = `https://openweathermap.org/img/wn/${day.weather.icon}@2x.png`;
                return `
                  <div style="background: rgba(0, 136, 204, 0.4); border-radius: 12px; padding: 10px 14px; margin-bottom:10px; font-weight:700; font-size:0.9rem; display:flex; justify-content:space-between; align-items:center; color:#BDEFFF;">
                    <div>${day.date}</div>
                    <div>${day.minTemp.toFixed(1)}°C - ${day.maxTemp.toFixed(1)}°C</div>
                    <img src="${iconUrl}" alt="${day.weather.main}" style="width:40px; height:40px;"/>
                  </div>
                `;
              })
              .join('');
            renderChart(
              dailySummaries.map(d => d.date),
              dailySummaries.map(d => d.maxTemp),
              dailySummaries.map(d => d.minTemp)
            );
          })
          .catch(() => {
            document.getElementById('forecastWidget').innerHTML =
              '<div class="error">Error fetching forecast data</div>';
          });
      }

      function getWeather() {
        const city = document.getElementById('cityInputWidget').value.trim();
        if (!city) {
          showError('Please enter a city name.');
          return;
        }
        clearError();
        document.getElementById('resultWidget').innerHTML = 'Loading...';
        document.getElementById('forecastWidget').innerHTML = '';
        clearChart();
        fetch(
          `https://api.openweathermap.org/data/2.5/weather?q=${encodeURIComponent(
            city
          )}&units=metric&appid=${apiKey}`
        )
          .then(res => {
            if (!res.ok) {
              if (res.status === 404)
                throw new Error('City not found. Check spelling.');
              if (res.status === 401) throw new Error('Invalid API key.');
              if (res.status === 429) throw new Error('API rate limit exceeded.');
              throw new Error(`Server error: ${res.statusText} (${res.status})`);
            }
            return res.json();
          })
          .then(data => {
            displayCurrentWeather(data);
            getForecast(data.coord.lat, data.coord.lon);
          })
          .catch(err => {
            showError(err.message);
          });
      }

      document
        .getElementById('getWeatherBtn')
        .addEventListener('click', getWeather);
      document
        .getElementById('cityInputWidget')
        .addEventListener('keypress', function (e) {
          if (e.key === 'Enter') getWeather();
        });
    })();
  </script>
</body>
</html>
